<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng ƒêi·ªÉm Danh Th√¥ng Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script async src="https://maps.googleapis.com/maps/api/js?key={{MAPS_API_KEY}}&callback=initMap"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        body {
            background-color: #F8FAFC; 
            min-height: 100vh;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1E293B;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; /* Gi√∫p ch·∫°m tr√™n ƒëi·ªán tho·∫°i kh√¥ng b·ªã nh√°y x√°m */
        }
        
        .bg-glow {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(224,231,255,0.8) 0%, rgba(248,250,252,0) 70%);
            border-radius: 50%;
            top: -200px;
            left: -100px;
            z-index: -1;
            pointer-events: none;
        }
        
        .bg-glow-2 {
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(243,232,255,0.6) 0%, rgba(248,250,252,0) 70%);
            border-radius: 50%;
            bottom: -100px;
            right: -100px;
            z-index: -1;
            pointer-events: none;
        }

        .bento-card {
            background: #FFFFFF;
            border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(241, 245, 249, 1);
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .bento-card { border-radius: 28px; }
        }

        .btn-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #4F46E5 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 20px -6px rgba(79, 70, 229, 0.4);
            border-radius: 9999px;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px -6px rgba(79, 70, 229, 0.5);
        }
        
        .btn-gradient:active {
            transform: translateY(1px);
            box-shadow: 0 4px 10px -4px rgba(79, 70, 229, 0.4);
        }

        .text-gradient {
            background: linear-gradient(135deg, #2563EB 0%, #4F46E5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .scan-focus-box {
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.55);
            transition: all 0.2s ease; /* Chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† cho 0.2s */
        }
        
        .scan-success {
            border-color: #10B981 !important;
            background-color: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.55), inset 0 0 30px rgba(16, 185, 129, 0.5);
        }

        .scanner-laser {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #3B82F6;
            box-shadow: 0 0 15px #3B82F6, 0 0 30px #60A5FA;
            top: 0;
            left: 0;
            animation: scan 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Custom Scrollbar Mobile & Desktop */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        @media (min-width: 768px) { .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; } }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #CBD5E1; }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-8 flex flex-col items-center">

    <div class="bg-glow"></div>
    <div class="bg-glow-2"></div>

    <header class="text-center mb-5 md:mb-10 w-full max-w-4xl mt-2 md:mt-4 relative z-10">
        <div class="inline-flex items-center justify-center p-2.5 md:p-3.5 bg-white rounded-[1rem] md:rounded-2xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] border border-slate-100 mb-3 md:mb-5 text-blue-600 transform transition hover:scale-105">
            <i class="ph-fill ph-aperture text-2xl md:text-3xl"></i>
        </div>
        <h1 class="text-2xl sm:text-3xl md:text-5xl font-extrabold mb-2 md:mb-4 text-slate-800 tracking-tight">
            H·ªá Th·ªëng ƒêi·ªÉm Danh <span class="text-gradient">T·ª± ƒê·ªông</span>
        </h1>
        <p class="text-[13px] sm:text-sm md:text-lg text-slate-500 max-w-2xl mx-auto font-medium px-4">
            ƒê∆∞a <b class="text-blue-600">M√£ V·∫°ch</b> tr√™n th·∫ª v√†o khung h√¨nh ƒë·ªÉ nh·∫≠n di·ªán si√™u t·ªëc.
        </p>
    </header>

    <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-5 md:gap-8 relative z-10">
        
        <!-- C·ªòT TR√ÅI: KHU V·ª∞C CAMERA -->
        <div class="lg:col-span-7 flex flex-col h-full">
            <div class="bento-card p-4 sm:p-5 md:p-8 flex-grow flex flex-col">
                <div class="flex flex-wrap justify-between items-center gap-2 mb-4 md:mb-6">
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0">
                            <i class="ph-fill ph-scan text-lg md:text-xl"></i>
                        </div>
                        <h2 class="text-base sm:text-lg font-bold text-slate-800">M√°y Qu√©t To√†n NƒÉng</h2>
                    </div>
                    
                    <div class="flex items-center gap-1.5 md:gap-2">
                        <span id="auto-badge" class="hidden px-2 md:px-3 py-1 bg-blue-50 text-blue-600 border border-blue-100 text-[10px] md:text-[11px] font-bold rounded-full animate-pulse flex items-center gap-1 md:gap-1.5 shadow-sm">
                            <i class="ph-fill ph-record text-blue-500"></i> ƒêANG QU√âT
                        </span>
                    </div>
                </div>
                
                <!-- üåü T·ªêI ∆ØU MOBILE: ƒê·ªïi aspect-video th√†nh aspect-[4/3] tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ camera kh√¥ng b·ªã d·∫πt -->
                <div class="relative w-full bg-slate-900 rounded-[16px] md:rounded-[20px] overflow-hidden aspect-[4/3] md:aspect-video flex items-center justify-center shadow-lg border-2 md:border-4 border-slate-50">
                    <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                    
                    <div id="scan-guide" class="absolute inset-0 hidden items-center justify-center pointer-events-none z-10">
                        <!-- üåü T·ªêI ∆ØU MOBILE: Khung l·∫•y n√©t r·ªông ngang, ng·∫Øn d·ªçc ƒë·ªÉ v·ª´a v·∫∑n m√£ v·∫°ch -->
                        <div id="focus-box" class="scan-focus-box w-[85%] h-[40%] md:w-[80%] md:h-[50%] relative overflow-hidden">
                            <div class="scanner-laser"></div>
                        </div>
                    </div>

                    <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 z-20 bg-slate-50/80 backdrop-blur-sm">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-white rounded-[1rem] md:rounded-2xl shadow-sm mb-3 md:mb-4 flex items-center justify-center border border-slate-100">
                            <i class="ph ph-video-camera-slash text-2xl md:text-3xl text-slate-400"></i>
                        </div>
                        <p class="font-semibold text-slate-500 text-[13px] md:text-base">Camera ƒëang ·ªü tr·∫°ng th√°i ngh·ªâ</p>
                    </div>
                </div>

                <div class="mt-4 md:mt-6 z-10">
                    <button id="btn-start-camera" onclick="khoiDongCamera()" class="w-full btn-gradient px-4 md:px-6 py-3.5 md:py-4 font-bold flex items-center justify-center gap-2 text-[15px] md:text-base shadow-md">
                        <i class="ph-fill ph-play-circle text-lg md:text-xl"></i> B·∫≠t Camera Qu√©t Th·∫ª
                    </button>
                </div>
                
                <!-- Th√¥ng b√°o tr·∫°ng th√°i t·ªëi ∆∞u UI cho ng√≥n tay -->
                <div id="system-status" class="mt-3 md:mt-5 p-3 md:p-4 rounded-[12px] md:rounded-[16px] bg-slate-50 border border-slate-100 flex items-center gap-2 md:gap-3 text-[12px] sm:text-[13px] md:text-sm font-medium text-slate-600 transition-all duration-300">
                    <i class="ph-fill ph-info text-slate-400 text-base md:text-lg shrink-0"></i>
                    <span>H·ªá th·ªëng ƒëang ·ªü tr·∫°ng th√°i ch·ªù. Vui l√≤ng k√≠ch ho·∫°t camera.</span>
                </div>
            </div>
        </div>

        <!-- C·ªòT PH·∫¢I: DANH S√ÅCH SINH VI√äN -->
        <div class="lg:col-span-5 h-full">
            <div class="bento-card p-4 sm:p-5 md:p-8 flex flex-col h-full max-h-[450px] lg:max-h-[750px]">
                <div class="flex justify-between items-center gap-2 mb-4 md:mb-6">
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
                            <i class="ph-fill ph-users-three text-lg md:text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-base sm:text-lg font-bold text-slate-800 leading-tight">Danh S√°ch L·ªõp</h2>
                            <p class="text-[11px] md:text-xs text-slate-500 font-medium mt-0.5">
                                ƒê√£ ƒë·∫øn: <strong id="count-attended" class="text-blue-600 text-[13px] md:text-sm">0</strong> / <span id="count-total">0</span>
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="tongHopBaoCao()" class="text-[12px] md:text-sm bg-white hover:bg-slate-50 text-slate-700 px-3 sm:px-4 md:px-5 py-2 md:py-2.5 rounded-full transition-all flex items-center gap-1.5 border border-slate-200 shadow-sm font-bold active:scale-95 shrink-0">
                        <i class="ph-fill ph-export text-blue-600 text-sm md:text-base"></i> <span class="hidden sm:inline">B√°o C√°o</span><span class="sm:hidden">Xu·∫•t</span>
                    </button>
                </div>

                <div class="flex-grow overflow-x-auto overflow-y-auto rounded-[12px] md:rounded-[16px] border border-slate-100 bg-slate-50/30 relative custom-scrollbar">
                    <table class="w-full text-left text-sm min-w-[280px] sm:min-w-[320px]">
                        <thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-100">
                            <tr>
                                <th class="p-3 md:p-4 font-bold text-slate-400 text-[9px] sm:text-[10px] md:text-xs uppercase tracking-wider">M√£ SV</th>
                                <th class="p-3 md:p-4 font-bold text-slate-400 text-[9px] sm:text-[10px] md:text-xs uppercase tracking-wider">H·ªç & T√™n</th>
                                <th class="p-3 md:p-4 font-bold text-slate-400 text-[9px] sm:text-[10px] md:text-xs uppercase tracking-wider text-right">Tr·∫°ng Th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL B√ÅO C√ÅO -->
    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-md transition-all duration-300 opacity-0 pointer-events-none p-4">
        <div class="bento-card p-5 md:p-8 w-full max-w-2xl relative transform transition-all duration-300 scale-95 shadow-2xl shadow-blue-900/10 flex flex-col max-h-[90vh]" id="report-modal-content">
            
            <div class="flex justify-between items-start mb-4 md:mb-5 border-b border-slate-100 pb-4 md:pb-5 shrink-0">
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 rounded-[1rem] bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0">
                        <i class="ph-fill ph-file-text text-xl md:text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg md:text-xl font-bold text-slate-800">T·ªïng H·ª£p B√°o C√°o</h3>
                        <p class="text-[11px] md:text-sm text-slate-500 mt-0.5 md:mt-1 font-medium">H·ªá th·ªëng t·ª± ƒë·ªông ƒë·ªëi chi·∫øu d·ªØ li·ªáu.</p>
                    </div>
                </div>
                <button onclick="dongModalBaoCao()" class="text-slate-400 hover:text-slate-600 transition-colors p-1.5 md:p-2 bg-slate-100 hover:bg-slate-200 rounded-full shrink-0">
                    <i class="ph ph-x text-base md:text-lg"></i>
                </button>
            </div>
            
            <div class="bg-slate-50 p-3 md:p-5 rounded-xl md:rounded-2xl border border-slate-100 relative flex-grow overflow-hidden flex flex-col">
                <textarea id="report-text-area" class="w-full h-full min-h-[150px] md:min-h-[250px] text-slate-700 text-[13px] sm:text-sm md:text-base font-medium resize-none focus:outline-none focus:ring-0 bg-transparent custom-scrollbar" readonly></textarea>
                
                <div id="copy-toast" class="absolute top-2 right-2 md:top-4 md:right-4 bg-emerald-100 text-emerald-700 px-2.5 md:px-3 py-1 md:py-1.5 rounded-full text-[10px] md:text-xs font-bold flex items-center gap-1 md:gap-1.5 opacity-0 transition-opacity shadow-sm">
                    <i class="ph-fill ph-check-circle"></i> ƒê√£ sao ch√©p!
                </div>
            </div>

            <div class="mt-4 md:mt-6 flex justify-end gap-2 md:gap-3 shrink-0">
                <button onclick="dongModalBaoCao()" class="px-4 md:px-6 py-2 md:py-3 rounded-full text-slate-500 text-[13px] md:text-base font-bold hover:bg-slate-100 transition-colors">
                    ƒê√≥ng
                </button>
                <button onclick="copyBaoCao()" class="btn-gradient px-5 md:px-8 py-2 md:py-3 text-[13px] md:text-base font-bold flex items-center gap-1.5 md:gap-2 shadow-md">
                    <i class="ph-fill ph-copy text-base md:text-lg"></i> Sao ch√©p
                </button>
            </div>
        </div>
    </div>

    <canvas id="snapshot-canvas" class="hidden"></canvas>

    <script>
        let GEMINI_API_KEY = '{{GEMINI_API_KEY}}'; 
        let GEMINI_MODEL = 'gemini-1.5-flash';
        
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        function initMap() {
            console.log("Kh·ªüi t·∫°o API Maps th√†nh c√¥ng.");
        }

        let danhSachSinhVien = [
            { maSV: '2512101028', ten: 'Nguy·ªÖn Kim B√¨nh An', daDen: false },
            { maSV: '2512101077', ten: 'Ph·∫°m Di·ªáp Anh', daDen: false },
            { maSV: '2512101075', ten: 'L√™ Vi·ªát Anh', daDen: false },
            { maSV: '2512101101', ten: 'Ng√¥ Xu√¢n B·∫£o', daDen: false },
            { maSV: '2512101091', ten: 'Nguy·ªÖn ƒê·ª©c Chung', daDen: false },
            { maSV: '2512101086', ten: 'Nguy·ªÖn Nh·∫≠t Duy', daDen: false },
            { maSV: '2512101020', ten: 'Nguy·ªÖn T·∫•n D≈©ng', daDen: false },
            { maSV: '2512101099', ten: 'B√πi VƒÉn D≈©ng', daDen: false },
            { maSV: '2512101047', ten: 'Cao ƒê·∫Øc ƒê·∫°t', daDen: false },
            { maSV: '2512101008', ten: 'Ph·∫°m Th√†nh ƒê·∫°t', daDen: false },
            { maSV: '2512101085', ten: 'Nguy·ªÖn Ng·ªçc ƒê·ª©c', daDen: false },
            { maSV: '2512101113', ten: 'Ho√†ng Th·ªã H√¢n', daDen: false },
            { maSV: '2512101022', ten: 'Ph·∫°m VƒÉn H√¢n', daDen: false },
            { maSV: '2512101025', ten: 'Nguy·ªÖn Ch√≠ Hi·∫øu', daDen: false },
            { maSV: '2512101007', ten: 'H√† ƒê·ª©c Hi·∫øu', daDen: false },
            { maSV: '2512101081', ten: 'Nguy·ªÖn Trung Hi·∫øu', daDen: false },
            { maSV: '2512751015', ten: 'Ph·∫°m Ho√†ng Hi·ªáp', daDen: false },
            { maSV: '2512101087', ten: 'Nguy·ªÖn Ti·∫øn Ho√†ng', daDen: false },
            { maSV: '2512101067', ten: 'Ph·∫°m VƒÉn Ho√†ng', daDen: false },
            { maSV: '2512101062', ten: 'Ng√¥ Ho√†ng Huy', daDen: false },
            { maSV: '2512101037', ten: 'Ph·∫°m Qu·ªëc Huy', daDen: false },
            { maSV: '2512101018', ten: 'Ph·∫°m Kh√°nh H∆∞ng', daDen: false },
            { maSV: '2512101060', ten: 'Tr·∫ßn Duy Kh√°nh', daDen: false },
            { maSV: '2512101016', ten: 'L√™ ƒê√¨nh Minh Kh√¥i', daDen: false },
            { maSV: '2512101042', ten: 'Nguy·ªÖn Ho√†ng Long', daDen: false },
            { maSV: '2512101092', ten: 'Tr·∫ßn Kh√°nh Ly', daDen: false },
            { maSV: '2512101069', ten: 'L√™ Minh', daDen: false },
            { maSV: '2512101019', ten: 'L√™ ƒê·ª©c Minh', daDen: false },
            { maSV: '2512101073', ten: 'Nguy·ªÖn Ph√∫ Minh', daDen: false },
            { maSV: '2512101125', ten: 'Nguy·ªÖn Th·ªã Ng·ªçc Minh', daDen: false },
            { maSV: '2512101095', ten: 'Ph·∫°m Trung Nghƒ©a', daDen: false },
            { maSV: '2512101011', ten: 'ƒê·ªó Kh√°nh Nguy√™n', daDen: false },
            { maSV: '2512101112', ten: 'Ho√†ng Th·ªã Nhi√™n', daDen: false },
            { maSV: '2512101089', ten: 'V≈© ƒê·ª©c Phong', daDen: false },
            { maSV: '2512101083', ten: 'L√™ Th·∫ø Ho√†ng Phong', daDen: false },
            { maSV: '2512101110', ten: 'Nguy·ªÖn Mai Ph∆∞∆°ng', daDen: false },
            { maSV: '2512101084', ten: 'Nguy·ªÖn Anh Qu√¢n', daDen: false },
            { maSV: '2512101013', ten: 'H√† C√¥ng Quy·ªÅn', daDen: false },
            { maSV: '2512101065', ten: 'Ho√†ng Th√°i S∆°n', daDen: false },
            { maSV: '2512101055', ten: 'Nguy·ªÖn C√¥ng Ti·∫øn', daDen: false },
            { maSV: '2512101004', ten: 'Nguy·ªÖn VƒÉn Tr∆∞·ªùng', daDen: false },
            { maSV: '2512101005', ten: 'T√¥ Anh Tu·∫•n', daDen: false },
            { maSV: '2512101049', ten: 'ƒê·ªó Anh T√∫', daDen: false },
            { maSV: '2512101009', ten: 'Nguy·ªÖn Quang Vinh', daDen: false }
        ];

        let videoStream = null;
        let barcodeReader = null; 
        let nativeDetector = null; 
        
        let dangBanDocMaVach = false; 
        let dangBanDocGemini = false; 

        window.onload = function() {
            renderDanhSach();
            capNhatTrangThai(`<i class="ph-fill ph-check-circle text-emerald-500 text-base md:text-lg"></i> N·∫°p ${danhSachSinhVien.length} h·ªì s∆° th√†nh c√¥ng.`, 'info');
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
                window.speechSynthesis.getVoices();
            }
        };

        async function khoiDongCamera() {
            const video = document.getElementById('camera-feed');
            const placeholder = document.getElementById('camera-placeholder');
            const btnStart = document.getElementById('btn-start-camera');

            try {
                btnStart.innerHTML = `<i class="ph-fill ph-spinner-gap animate-spin text-lg md:text-xl"></i> Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng...`;
                btnStart.disabled = true;

                try {
                    if ('BarcodeDetector' in window) {
                        nativeDetector = new BarcodeDetector({ formats: ['code_128'] });
                    }
                } catch (e) {
                    console.log("BarcodeDetector kh√¥ng h·ªó tr·ª£, s·ª≠ d·ª•ng th∆∞ vi·ªán ZXing d·ª± ph√≤ng.");
                }

                if (!barcodeReader) {
                    const hints = new Map();
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.CODE_128]);
                    barcodeReader = new ZXing.BrowserMultiFormatReader(hints); 
                }

                // Xin quy·ªÅn v·ªõi l√Ω t∆∞·ªüng s·∫Øc n√©t, ∆∞u ti√™n camera sau
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                
                video.srcObject = videoStream;
                video.setAttribute("playsinline", true);
                video.play();
                
                placeholder.style.display = 'none';
                btnStart.style.display = 'none';
                document.getElementById('scan-guide').classList.remove('hidden');
                document.getElementById('scan-guide').classList.add('flex');
                document.getElementById('auto-badge').classList.remove('hidden');
                
                capNhatTrangThai(`<i class="ph-fill ph-rocket text-blue-500 text-base md:text-lg"></i> S·∫µn s√†ng! AI ƒëang b·∫£o v·ªá ng·∫ßm.`, "success");
                
                vongLapQuetMaVach(); 
                vongLapGeminiAI();   

            } catch (err) {
                console.error(err);
                capNhatTrangThai(`<i class="ph-fill ph-warning-circle text-rose-500 text-base md:text-lg"></i> B·ªã t·ª´ ch·ªëi quy·ªÅn camera.`, "error");
                btnStart.innerHTML = `<i class="ph-fill ph-arrow-counter-clockwise text-lg md:text-xl"></i> Th·ª≠ K√≠ch Ho·∫°t L·∫°i`;
                btnStart.disabled = false;
            }
        }

        async function vongLapQuetMaVach() {
            if (!videoStream) return;
            if (dangBanDocMaVach) {
                // ‚ö° √âp xung: Gi·∫£m ƒë·ªô tr·ªÖ ch·ªù l·∫∑p l·∫°i xu·ªëng 50ms (G·∫ßn nh∆∞ li√™n t·ª•c)
                setTimeout(vongLapQuetMaVach, 50);
                return;
            }

            const video = document.getElementById('camera-feed');
            
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                dangBanDocMaVach = true; 
                let barcodeText = null;

                try {
                    if (nativeDetector) {
                        const barcodes = await nativeDetector.detect(video);
                        if (barcodes.length > 0) barcodeText = barcodes[0].rawValue.toUpperCase();
                    }

                    if (!barcodeText && barcodeReader) {
                        const canvas = document.getElementById('snapshot-canvas');
                        const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        const cropWidth = video.videoWidth * 0.8;
                        const cropHeight = video.videoHeight * 0.4;
                        const startX = (video.videoWidth - cropWidth) / 2;
                        const startY = (video.videoHeight - cropHeight) / 2;

                        canvas.width = cropWidth;
                        canvas.height = cropHeight;
                        
                        ctx.filter = 'grayscale(100%) contrast(250%)';
                        ctx.drawImage(video, startX, startY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                        ctx.filter = 'none'; 
                        
                        try {
                            const result = await barcodeReader.decodeFromCanvas(canvas);
                            barcodeText = result.text.toUpperCase();
                        } catch (e) {}
                    }
                    
                    if (barcodeText) {
                        for (let i = 0; i < danhSachSinhVien.length; i++) {
                            let sv = danhSachSinhVien[i];
                            if (sv.daDen) continue;

                            if (barcodeText === sv.maSV.toUpperCase()) {
                                sv.daDen = true;
                                hieuUngThanhCong();
                                docTenSinhVien();
                                renderDanhSach();
                                capNhatTrangThai(`<i class="ph-fill ph-check-circle text-emerald-500 text-base md:text-lg"></i> ƒêi·ªÉm danh: <b class="text-slate-800">${sv.ten}</b>`, "success");
                                break;
                            }
                        }
                        
                        // ‚ö° √âp xung: Gi·∫£m th·ªùi gian kh√≥a nh·ªãp (cooldown) xu·ªëng ƒë√∫ng 200ms (0.2s) theo l·ªánh anh Ho√†ng!
                        setTimeout(() => {
                            dangBanDocMaVach = false;
                            vongLapQuetMaVach();
                        }, 200); 
                        return; 
                    }
                } catch (err) {}
                
                dangBanDocMaVach = false;
            }
            setTimeout(vongLapQuetMaVach, 50); // ‚ö° Gi·∫£m delay ch·ªù l·∫∑p l·∫°i
        }

        async function vongLapGeminiAI() {
            if (!videoStream) return;
            if (dangBanDocGemini) return; 

            const video = document.getElementById('camera-feed');
            
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                dangBanDocGemini = true;

                try {
                    const canvas = document.createElement('canvas');
                    const cropWidth = video.videoWidth * 0.7; 
                    const cropHeight = video.videoHeight * 0.4;
                    const scaleFactor = 0.5; 
                    
                    canvas.width = cropWidth * scaleFactor;
                    canvas.height = cropHeight * scaleFactor;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.drawImage(video, (video.videoWidth - cropWidth) / 2, (video.videoHeight - cropHeight) / 2, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);
                    
                    const base64ImageData = canvas.toDataURL('image/jpeg', 0.4).split(',')[1];
                    const promptText = "Tr√≠ch xu·∫•t d√£y s·ªë M√£ Sinh Vi√™n (kho·∫£ng 10 ch·ªØ s·ªë) t·ª´ th·∫ª n√†y. Ch·ªâ in ra d√£y s·ªë.";

                    const response = await fetch(GEMINI_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: promptText },
                                    { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                                ]
                            }],
                            systemInstruction: { parts: [{ text: "Tr√≠ch xu·∫•t m√£ sinh vi√™n ch√≠nh x√°c tuy·ªát ƒë·ªëi." }] }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (aiText) {
                            aiText = aiText.trim().toUpperCase();
                            for (let i = 0; i < danhSachSinhVien.length; i++) {
                                let sv = danhSachSinhVien[i];
                                if (!sv.daDen && aiText.includes(sv.maSV.toUpperCase())) {
                                    sv.daDen = true;
                                    hieuUngThanhCong();
                                    docTenSinhVien();
                                    renderDanhSach();
                                    capNhatTrangThai(`<i class="ph-fill ph-magic-wand text-purple-500 text-base md:text-lg"></i> AI: <b class="text-slate-800">${sv.ten}</b> (${sv.maSV})`, "success");
                                    break;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log("L·ªói k·∫øt n·ªëi AI ng·∫ßm:", error);
                }
            }
            
            dangBanDocGemini = false;
            setTimeout(vongLapGeminiAI, 1000); // ‚ö° AI Ng·∫ßm g·ªçi m·ªói gi√¢y ƒë·ªÉ gi·ªØ ƒë·ªô ·ªïn ƒë·ªãnh m√°y ch·ªß
        }

        function docTenSinhVien() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance('√î k√™');
                utterance.lang = 'vi-VN';
                utterance.rate = 1.3;
                utterance.pitch = 1.3;
                
                const voices = window.speechSynthesis.getVoices();
                const viVoice = voices.find(voice => voice.lang.includes('vi') && (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('google')));
                if (viVoice) {
                    utterance.voice = viVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        function hieuUngThanhCong() {
            const focusBox = document.getElementById('focus-box');
            focusBox.classList.add('scan-success');
            // ‚ö° √âp xung: Gi·∫£m th·ªùi gian ch·ªõp nh√°y th√†nh c√¥ng xu·ªëng c√≤n 0.2s (200ms)
            setTimeout(() => focusBox.classList.remove('scan-success'), 200);
        }

        function renderDanhSach() {
            const tbody = document.getElementById('student-table-body');
            const countAttended = document.getElementById('count-attended');
            const countTotal = document.getElementById('count-total');

            tbody.innerHTML = '';
            let soNguoiDaDen = 0;

            danhSachSinhVien.forEach((sv, index) => {
                if (sv.daDen) soNguoiDaDen++;
                
                const rowClass = sv.daDen ? "bg-white" : "hover:bg-slate-100/50 transition-colors";
                const statusHtml = sv.daDen 
                    ? `<span class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full text-[9px] sm:text-[11px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-100"><i class="ph-fill ph-check-circle text-xs sm:text-sm"></i> ƒê√£ C√≥ M·∫∑t</span>`
                    : `<span class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full text-[9px] sm:text-[11px] font-bold bg-slate-100 text-slate-500 border border-slate-200"><i class="ph-fill ph-minus-circle text-xs sm:text-sm"></i> V·∫Øng M·∫∑t</span>`;

                tbody.innerHTML += `
                    <tr class="${rowClass} cursor-pointer border-b border-slate-100/80 last:border-0 group" onclick="diemDanhThuCong(${index})">
                        <td class="p-3 md:p-4 font-mono text-slate-500 text-[11px] sm:text-xs md:text-sm group-hover:text-blue-600 transition-colors align-middle">${sv.maSV}</td>
                        <td class="p-3 md:p-4 font-semibold text-slate-700 text-[11px] sm:text-xs md:text-sm align-middle">${sv.ten}</td>
                        <td class="p-3 md:p-4 text-right align-middle whitespace-nowrap">${statusHtml}</td>
                    </tr>
                `;
            });

            countAttended.innerText = soNguoiDaDen;
            countTotal.innerText = danhSachSinhVien.length;
        }

        function diemDanhThuCong(index) {
            let sv = danhSachSinhVien[index];
            sv.daDen = !sv.daDen; 
            renderDanhSach();
            if(sv.daDen) capNhatTrangThai(`<i class="ph-fill ph-pencil-simple text-blue-500 text-base md:text-lg"></i> C·∫≠p nh·∫≠t th·ªß c√¥ng: <b class="text-slate-800">${sv.ten}</b>`, "info");
            else capNhatTrangThai(`<i class="ph-fill ph-eraser text-amber-500 text-base md:text-lg"></i> H·ªßy ƒëi·ªÉm danh: <b class="text-slate-800">${sv.ten}</b>`, "warning");
        }

        function capNhatTrangThai(message, type = 'info') {
            const statusBox = document.getElementById('system-status');
            statusBox.innerHTML = message;
            
            statusBox.className = "mt-3 md:mt-5 p-3 md:p-4 rounded-[12px] md:rounded-[16px] flex items-center gap-2 md:gap-3 text-xs md:text-sm font-medium transition-all duration-300 ";
            
            if (type === 'success') statusBox.className += "bg-emerald-50 text-emerald-700 border border-emerald-100";
            else if (type === 'error') statusBox.className += "bg-rose-50 text-rose-700 border border-rose-100";
            else if (type === 'warning') statusBox.className += "bg-amber-50 text-amber-700 border border-amber-100";
            else statusBox.className += "bg-slate-50 text-slate-600 border border-slate-100";
        }

        async function tongHopBaoCao() {
            capNhatTrangThai(`<i class="ph-fill ph-spinner-gap animate-spin text-blue-500 text-base md:text-lg"></i> ƒêang t·∫£i d·ªØ li·ªáu...`, "loading");
            try {
                const docId = '1mQwL6HWog20bK21V7C8fhmj30yhe35xBHAl3nvVkMkY';
                const exportUrl = `https://docs.google.com/document/d/${docId}/export?format=txt`;
                
                const proxies = [
                    `https://corsproxy.io/?${encodeURIComponent(exportUrl)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(exportUrl)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(exportUrl)}`
                ];

                let textData = null;

                for (let proxyUrl of proxies) {
                    try {
                        const response = await fetch(proxyUrl);
                        if (response.ok) {
                            textData = await response.text();
                            break; 
                        }
                    } catch (err) {
                        console.log("Tr·∫°m trung chuy·ªÉn n√†y ƒëang b·∫≠n, th·ª≠ tr·∫°m kh√°c...");
                    }
                }

                if (!textData) {
                    throw new Error("T·∫•t c·∫£ c√°c tr·∫°m trung chuy·ªÉn ƒë·ªÅu b·ªã ngh·∫Ωn.");
                }
                
                const danhSachXinPhep = textData.split('\n').map(line => line.trim().toUpperCase()).filter(line => line.length > 0);

                let vangKhongPhep = [];
                let vangCoPhep = [];

                danhSachSinhVien.forEach(sv => {
                    if (!sv.daDen) {
                        const laCoPhep = danhSachXinPhep.some(line => line.includes(sv.maSV.toUpperCase()) || line.includes(sv.ten.toUpperCase()));
                        if (laCoPhep) vangCoPhep.push(sv);
                        else vangKhongPhep.push(sv);
                    }
                });

                const homNay = new Date();
                const ngayThang = `${String(homNay.getDate()).padStart(2, '0')}/${String(homNay.getMonth() + 1).padStart(2, '0')}/${homNay.getFullYear()}`;
                
                let noiDung = `Th·∫ßy/C√¥ ∆°i, h√¥m nay ng√†y ${ngayThang} l·ªõp CT2901 v·∫Øng nh·ªØng b·∫°n sau:\n\n- Nh·ªØng b·∫°n kh√¥ng ph√©p:\n`;
                if (vangKhongPhep.length === 0) noiDung += `  (Kh√¥ng c√≥)\n`;
                else vangKhongPhep.forEach(sv => noiDung += `  + ${sv.ten} - ${sv.maSV}\n`);
                
                noiDung += `\n- Nh·ªØng b·∫°n c√≥ ph√©p:\n`;
                if (vangCoPhep.length === 0) noiDung += `  (Kh√¥ng c√≥)\n`;
                else vangCoPhep.forEach(sv => noiDung += `  + ${sv.ten} - ${sv.maSV}\n`);

                document.getElementById('report-text-area').value = noiDung;
                moModalBaoCao();
                capNhatTrangThai(`<i class="ph-fill ph-check-circle text-emerald-500 text-base md:text-lg"></i> B√°o c√°o ƒë√£ s·∫µn s√†ng!`, "success");
            } catch (error) {
                console.error(error);
                capNhatTrangThai(`<i class="ph-fill ph-warning-circle text-rose-500 text-base md:text-lg"></i> L·ªói k·∫øt n·ªëi ƒë√°m m√¢y!`, "error");
            }
        }

        function moModalBaoCao() {
            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function dongModalBaoCao() {
            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
        }

        function copyBaoCao() {
            const textArea = document.getElementById('report-text-area');
            textArea.select();
            textArea.setSelectionRange(0, 99999); 
            document.execCommand('copy');
            
            const toast = document.getElementById('copy-toast');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000);
            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
